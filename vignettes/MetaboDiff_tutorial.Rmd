---
title: 'MetaboDiff tutorial'
author: | 
  | Andreas Mock
  | Experimental Neurosurgery, Heidelberg University Hospital,
  | Division of Applied Bioinformatics, German Cancer Research Center (DFKZ) Heidelberg &
  | Department of Medical Oncology, National Center for Tumor Diseases (NCT) Heidelberg
date: '`r Sys.Date()`'
output:
  github_document:
    toc: true
    toc_depth: 2
fig_caption: yes
---

# Introduction

Comparative non-targeted metabolomics comes of age through an increasing number of commercial vendors offering reproducible high-quality metabolomic data for translational researchers outside the mass spectrometry field. This R packages aims to provide a low-level entry to differential metabolomic analysis by starting off with the table of relative metabolite quantifications provided by commercial vendors or core facilities. 

# Installation

The `MetaboDiff` R package can be installed via Github. Please note that `MetaboDiff` requires an R version >= 3.4. 

## Install dependencies

Please note that CRAN occasionally fails to compile the `WGCNA` package for Mac OS X. Hence, we recommend to install the package before installing `MetaboDiff`:

```{r, eval=FALSE}
install.packages("WGCNA")
```

If asked, install the package from source. Please refer to the [developer page](https://labs.genetics.ucla.edu/horvath/CoexpressionNetwork/Rpackages/WGCNA/)  
if you encounter problems installing the `WGCNA` package.

## Install MetaboDiff

```{r, eval=FALSE}
library("devtools")
install_github("andreasmock/MetaboDiff")
```

and once installed loaded by

```{r, message=FALSE}
library("MetaboDiff")
```

# Part I: Data processing

## Reading data and annotation

### Example data

The example data is derived from a study by Priolo and colleagues in which they used the service of Metabolon&reg; to compare the tissue metabolome of 40 prostate cancers with 16 normal prostate specimens [^1]. 
The table summarizing the relative metabolic measurements can be loaded from the journal homepage as follows:

```{r, eval=TRUE, message=FALSE}
data = as.matrix(gdata::read.xls("http://cancerres.aacrjournals.org/highwire/filestream/290852/field_highwire_adjunct_files/4/131853_1_supp_2658512_nbpsn6.xlsx",
                          sheet=5,
                          na.strings = ""))
```

### Input files

The metabolomic data within `MetaboDiff` is stored as a `MultiAssayExperiment`class [^2]. This framework enables the coordinated representation of multiple experiments on partially overlapping samples with associated metadata and integrated subsetting across experiments. In the context of metabolomic data analysis, multiple assays are needed to store raw data and imputed data which usually contain different number of metabolites due to missing values (see section on data imputation for more details). 

The core components of the `MultiAssayExperiment` class are:

* `ExperimentList` - a slot of class ExperimentList containing data for each experimental assay. Within the ExperimentList slot, the metabolomic data are stored as  
SummarizedExperiment objects consisting of:
    + `assay` - a matrix containing the relative metabolic measurements. 
    + `rowData` - a dataframe containing the metabolite annotation..
* `colData` - a slot of class data frame describing the sample metadata available across all experiments
* `sampleMap` - a slot of class data frame relating clinical data to experimental assay
* `metadata` - a slot of class list. Within MetaboDiff, this slot contains a list of dataframes summarizing the results from the hypothesis testing.

#### Creation of assay object containing metabolomic data

```{r}
assay = apply(data[3:nrow(data),8:ncol(data)],2,as.numeric)
colnames(assay) = paste0(rep("sample",ncol(assay)),1:ncol(assay))
rownames(assay) = paste0(rep("met",nrow(assay)),1:nrow(assay))
assay[1:4,1:5]
```

#### Creation of colData object containing sample metadata

```{r}
colData = data.frame(id = colnames(t(data[1,8:ncol(data)])),
                     tumor_normal = as.vector(t(data[1,8:ncol(data)])),
                   row.names=paste0(rep("pat",ncol(assay)),1:ncol(assay)))
```

To showcase the full functionality of `MetaboDiff`, we generate a second random group label "random_gender".

```{r}
#set seed for reproducibility 
set.seed(1)

colData$random_gender = sample(c("random_male","random_female"),size = nrow(colData),replace = TRUE)
head(colData)
```


#### Creation of rowData object containing metabolite annotations and ids 

For the rowData object we start off with the annotation already provided by the commercial vendor: 

```{r}
rowData = as.data.frame(data[3:nrow(data),1:7])
colnames(rowData) = data[2,1:7]
colnames(rowData)[7] = "HMDB_ID"
rownames(rowData) = paste0(rep("met",nrow(assay)),1:nrow(assay))
colnames(rowData)
```

#### Annotation using Small Molecular Pathway Database (SMPDB)

Alongside the metabolic measurements, Metabolon&reg; provides metabolite annotation including so called super-pathways and sub-pathways. However, theses annotations might very from vendor to vendor. Hence, the `MetaboDiff` package makes use of the Small Molecular Pathway Database (SMPDB) for metabolite annotation [^3]. `MetaboDiff` supports all common metabolic IDs as input for the annotation (HMDB, KEGG and ChEBI). In the example data, both the KEGG and the HMDB identifier are available. As the databases (HMDB, KEGG or ChEBI) cover unique annotations due to different standards in identifying and reporting metabolites [^4], the function `get_SMPDBanno` queries the database using all three ids (if available) and joins all available information. The current SMPDB build used within `MetaboDiff` is version 2.0 and will be updated as new versions are released. Please refer to the development branch of `MetaboDiff` to work with the latest SMPDB annotation.

```{r}
rowData = get_SMPDBanno(rowData,
                        column_kegg_id=6,
                        column_hmdb_id=7,
                        column_chebi_id=NA)
```

### Creation of SummarizedExperiment object and ExperimentList

```{r}
se = SummarizedExperiment(assays=assay,
                           rowData=rowData)
experiment_list = list(raw=se)
experiment_list
```

### Creation of sampleMap 

```{r}
sampleMap = data.frame(primary=rownames(colData),
                 colname=colnames(se))
sampleMap_list = listToMap(list(raw=sampleMap))
```

### Construction of MultiAssayExperiment

```{r, message=FALSE, warning=FALSE}
met = MultiAssayExperiment(experiments = experiment_list,
                           colData = colData,
                           sampleMap = sampleMap_list)
met
```

## Imputation of missing values

In contrast to other high-throughput technologies, missing values are common in quantitative metabolomic datasets. 

The function `na_heatmap` visualizes the missing metabolite measurements across the samples. The name of the column in colData for grouping and the label colors for the two groups need to be specified.

```{r}
na_heatmap(met,
           group_factor="tumor_normal",
           label_colors=c("darkseagreen","dodgerblue"))
```

The example data supports the need for data imputation. It could be shown that k-nearest neighbor imputation minimizes the effects on the normality and variance of the data as long as the number of missing data does not exceed 40% [^5]. 

The function 'knn_impute' adds the slot "impute" to the MultiAssayExperiment object that contains the imputed relative metabolite measurements for all metabolites with raw measurements in more than 60% of cases. We recommend a cutoff of 40% (i.e. 0.4). However the cutoff might be changed according to the discretion of the user.

```{r}
met = knn_impute(met,cutoff=0.4)
met
```

As apparent form the summary description of the object 'met' the imputed data matrix contains only 238 of the 307 original metabolites according the cutoff of 40% missing values.

## Removal of outliers

Before we normalize the data, we want to exclude outliers in the study set. To this end, we provide the function `outlier_heatmap`.
The sample annotation shows the number of missing metabolites per sample as the proxy of the impact of imputation on clustering. 
To showcase outliers, the hierarchical clustering tree is cut in 2 clusters.

```{r}
outlier_heatmap(met,
                group_factor="tumor_normal",
                label_colors=c("darkseagreen","dodgerblue"))
```

The imputed data of the example study set displays a cluster of 5 samples (cluster 1) with an in average lower relative metabolite abundance. Due to the lack of batch information, this cannot be investigted further at this time. To demonstrate, how a cluster can be removed, we apply the function `remove_cluster` to remove cluster 1:

```{r, message=FALSE}
met = remove_cluster(met,cluster=1)
met
```

As displayed in the summary of the `met` object, the 5 samples of cluster 1 were successfully removed from the slots "raw" and "imputed".

## Normalization

Variance stabilizing normalization (vsn) is used ensure that the variance remains nearly constant over the measured spectrum (Huber et al., 2002).

```{r}
met = normalize_met(met)
```

## Summary of processed object

```{r}
met
```

At this point the data processing is completed. The `MultiAssayExperiment` object contains now 4 slots:

- raw - raw relative metabolic measurements as provided by company or core facility
- imputed - imputed relative metabolic measurements (k-nearest neighbor imputation)
- norm - normalized relative metabolic measurements (vsn)
- norm_imputed - normalized imputed relative metabolic measurements (vsn)

## Quality control of normalization

```{r,fig.width=10,fig.height=8, message=FALSE, warning=FALSE}
quality_plot(met,
             group_factor="tumor_normal",
             label_colors=c("darkseagreen","dodgerblue"))
```

# Part II: Data analysis

## Principal component analysis (PCA)

```{r}
metadata(met)$res_pca = FactoMineR::PCA(t(assays(met)[["norm_imputed"]]), 
              scale.unit = TRUE,
              graph=FALSE)
```

Visualize percentage of explained variances for the first ten principal components i.e. dimensions.

```{r}
factoextra::fviz_screeplot(metadata(met)$res_pca , addlabels=TRUE)
```

PCA plot.

```{r}
factoextra::fviz_pca_ind(metadata(met)$res_pca,
             label="none",
             habillage=colData(met)[["tumor_normal"]],
             palette=c("darkseagreen","dodgerblue"),
             addEllipses = TRUE)
```

## Hypothesis testing

Differential analysis for individual metabolites is performed using Student's T-Test. Correction for multiple testing is performed by independent hypothesis weighting (IHW [^6]) with variance as a covariate. 

Hypothesis testing will be performed for the sample grouping "tumor_normal", as well for the randomly generated grouping "random_gender".

```{r, message=FALSE}
met = diff_test(met,
                group_factors = c("tumor_normal","random_gender"))
```

The results of the hypothesis testing is saved in the `metadata` splot of the MultiAssayExperiment object. 

```{r}
str(metadata(met), max.level=2)
```

The columns of the result data frame are the unadjusted p-value (pval), the adjusted p-value by independent hypothesis weighting (adj_pval), the  Fold-Change between groups (fold_change) and the variance (var).

The comparative analysis is visualized by means of a volcano plot.

```{r}
volcano_plot(met, 
             group_factor="tumor_normal",
             label_colors=c("darkseagreen","dodgerblue"))
```

As a sanity check, we also display the volcano plot for the random grouping "random_gender" for which we would not expect the same number of significant metabolites.

```{r}
volcano_plot(met, 
             group_factor="random_gender",
             label_colors=c("brown","orange"))
```

As expected, no metabolites was significant different between the randomly assigned grouping male vs. female after multiple testing with a cutoff of p_adjust < 0.05.

## Pathway analysis

In this part of the analysis, we will exploit the Small molecular Pathway Database (SMPDB) annotation to explore metabolic pathways and perform an enrichment analysis.

The annotations from the SMPDB has the prefix "SMPDB|". The remaining annotation was provided by the commercial vendor that generated the example data (i.e. Metabolon&reg;).

```{r}
colnames(rowData(met[["norm_imputed"]]))
```

```{r, fig.width=8, fig.height=9}
variance_boxplot(met,
                 rowAnnotation = "SMPDB|Pathway.Name")
```


## Metabolic correlation network analysis

This section describes the generation and analysis of metabolic correlation networks. The workflow was adapted from the weighted gene co-expression analysis (WGCNA) proposed by Langfelder and Horvarth [^7].

### Construction dissiumilarity matrix

The first step in constructing a metabolic correlation network is the creation of a dissimilarity matrix. Biweight midcorrelation was used as a similiarity measure as it is more robust to outliers than the absolute correlation coefficient [^8]. This choice is important, as we do not expect metabolites to be correlated in all patients. 

The core concept of the so called "weighted" correlation analysis by Langfelder and Horvarth is that instead of defining a "hard" threshold (e.g. an absolute correlation coefficient > 0.8) to decide whether a node as connected to another, the adjacency `a` is defined by raising the similarity `s` to a power `beta` ('soft' threshold):

$$a_{ij} = s_{ij}^\beta$$
Lastly, the dissimilarity measure is defined by

$$w_{ij} = 1 - a_{ij}$$

For detailed rational of this approach, please see Zhang and Horvath[^9]. For metabolic networks, we identified that a beta value of 3 was the lowest power for which the scale-free topology of the topology was met.

The function `diss_matrix` creates the dissimilarity measure for the `met` objects and saves it in the metadata slot

```{r}
met = diss_matrix(met)
str(metadata(met), max.level=2)
```

### Identification of metabolic correlation modules

To identify metabolic correlation modules, metabolites are next clustered based on the dissimilarity measure, where branches of the dendrogram correspond to modules.  Ultimately, modules are detected by applying a branch cutting method. We employed the dynamic branch cut method developed by Langfelder and colleagues [^9], as constant height cutoffs exhibit suboptimal performance on complicated dendrograms. 


 
```{r}
met = identify_modules(met, 
                       min_module_size=5)
```

```{r}
#plot the dendrogram and corresponding colour bars underneath
WGCNA::plotDendroAndColors(metadata(met)$tree, 
                    metadata(met)$module_colors, 
                    'Module colors', 
                    dendroLabels = FALSE, 
                    hang = 0.03,
                    addGuide = TRUE, 
                    guideHang = 0.05, main='')
```

The relation between the identified co-expression modules can be visualized by a dendrogram of their *eigengenes*. The module *eigengene* is defined as the first principal component of its expression matrix. It could be shown that the module= *eigengene* is highly correlated with the gene that has the highest intramodular connectivity[^6].

```{r}
par(mar=c(2,2,2,2))
ape::plot.phylo(ape::as.phylo(metadata(met)$METree),
           type = 'fan',
           show.tip.label = FALSE, 
           main='')
ape::tiplabels(frame = 'circle',
          col='black', 
          text=rep('',length(unique(metadata(met)$modules))), 
          bg = levels(as.factor(metadata(met)$module_colors)))
```




# Session information

```{r}
sessionInfo()
```

# References
[^1]: Priolo, C., Pyne, S., Rose, J., Regan, E. R., Zadra, G., Photopoulos, C., et al. (2014). AKT1 and MYC Induce Distinctive Metabolic Fingerprints in Human Prostate Cancer. Cancer Research, 74(24), 7198–7204. http://doi.org/10.1158/0008-5472.CAN-14-1490

[^2]: Sig M (2017). MultiAssayExperiment: Software for the integration of multi-omics experiments in Bioconductor. R package version 1.2.1

[^3]: Jewison T, Su Y, Disfany FM, et al. SMPDB 2.0: Big Improvements to the Small Molecule Pathway Database Nucleic Acids Res. 2014 Jan;42(Database issue):D478-84.

[^4]: Thiele, I., Swainston, N., Fleming, R. M. T., Hoppe, A., Sahoo, S., Aurich, M. K., et al. (2013). A community-driven global reconstruction of human metabolism. Nature Biotechnology, 31(5), 419–425. http://doi.org/10.1038/nbt.2488

[^5]: Armitage, E. G., Godzien, J., Alonso-Herranz, V., L pez-Gonz lvez, N., & Barbas, C. (2015). Missing value imputation strategies for metabolomics data. Electrophoresis, 36(24), 3050–3060. http://doi.org/10.1002/elps.201500352

[^6]: Ignatiadis, N., Klaus, B., Zaugg, J. B., & Huber, W. (2016). Data-driven hypothesis weighting increases detection power in genome-scale multiple testing. Nature Methods, 13(7), 577–580. http://doi.org/10.1038/nmeth.3885

[^7]: Langfelder, P., & Horvath, S. (2008). WGCNA: an R package for weighted correlation network analysis. BMC Bioinformatics, 9, 559–559. http://doi.org/10.1186/1471-2105-9-559

[^8]: Zheng, C.-H., Yuan, L., Sha, W., & Sun, Z.-L. (2014). Gene differential coexpression analysis based on biweight correlation and maximum clique. BMC Bioinformatics, 15 Suppl 15(Suppl 15), S3. http://doi.org/10.1186/1471-2105-15-S15-S3

[^9]: Horvarth Paper.
