{
    "collab_server" : "",
    "contents" : "---\ntitle: 'MetaboDiff tutorial'\nauthor: | \n  | Andreas Mock\n  | Experimental Neurosurgery, Heidelberg University Hospital,\n  | Division of Applied Bioinformatics, German Cancer Research Center (DFKZ) Heidelberg &\n  | Department of Medical Oncology, National Center for Tumor Diseases (NCT) Heidelberg\ndate: '`r Sys.Date()`'\noutput: rmarkdown::github_document\nfig_caption: yes\n---\n\n```{r setup, include=FALSE}\nlibrary(\"devtools\")\nlibrary(\"gdata\")\nlibrary(\"MultiAssayExperiment\")\nlibrary(\"SummarizedExperiment\")\nlibrary(\"MetaboDiff\")\nlibrary(\"tidyverse\")\nlibrary(\"ggfortify\")\nlibrary(\"ComplexHeatmap\")\nlibrary(\"impute\")\nlibrary(\"vsn\")\nlibrary(\"HiveR\")\nlibrary(\"RColorBrewer\")\nlibrary(\"plyr\")\n\ninstall_github(\"andreasmock/MetaboDiff\")\n```\n\n# Introduction\n\nComparative metabolomics comes of age by an increasing number of commercial vendors (i.e. Metabolon &reg;) offering reproducible high-quality metabolomic data for translational researchers outside the mass spectrometry field. This R packages aims to provide a low-level entry to differential metabolomic analysis by starting off with the table of relative metabolite quantifications provided by commercial vendors.\n\nds\n\n# Installation\n\nThe `MetaboDiff` R package can be installed via Github\n\n```{r,eval=FALSE}\nlibrary(devtools)\ninstall_github(\"andreasmock/MetaboDiff\")\n```\n\nand once installed loaded by\n\n```{r,eval=FALSE, message=FALSE}\nlibrary(\"MetaboDiff\")\n```\n\n# Reading data and annotation\n\n## Example data\n\nThe example data is derived from a study by Priolo and colleagues in which they used the service of the Metabolon&reg; company to compare the tissue metabolome of 40 prostate cancers with 16 normal prostate specimens.[^1] \nThe table summarizing the relative metabolic measurements can be loaded from the journal homepage as follows:\n\n```{r, eval=TRUE, message=FALSE}\ndata = as.matrix(read.xls(\"http://cancerres.aacrjournals.org/highwire/filestream/290852/field_highwire_adjunct_files/4/131853_1_supp_2658512_nbpsn6.xlsx\",sheet=5,na.strings = \"\"))\n```\n\n## Input files\n\nThe metabolomic data within `MetaboDiff` is stored as a `MultiAssayExperiment`class [^2]. This framework enables the coordinated representation of multiple experiments on partially overlapping samples with associated metadata and integrated subsetting across experiments. In the context of metabolomic data analysis, multiple assays are needed to store raw data and imputed data (see section on data imputation). \n\nThe core components of the `MultiAssayExperiment` class are:\n\n* `ExperimentList` - a slot of class ExperimentList containing data for each experimental assay. Within the ExperimentList slot, the metabolomic data is stored as a \nSummarizedExperiment object consisting of:\n    + `assay` - a matrix containing the relative metabolic measurements. \n    + `rowData` - a dataframe containing the metabolite annotation..\n* `colData` - a slot of class data frame describing the sample metadata available across all experiments\n* `sampleMap` - a slot of class data frame relating clinical data to experimental assay\n\n### Creation of assay object containing metabolomic data\n\n```{r, eval=TRUE}\nassay = apply(data[3:nrow(data),8:ncol(data)],2,as.numeric)\ncolnames(assay) = paste0(rep(\"sample\",ncol(assay)),1:ncol(assay))\nrownames(assay) = paste0(rep(\"met\",nrow(assay)),1:nrow(assay))\nassay[1:4,1:5]\n```\n\n### Creation of colData object containing sample metadata\n\n```{r}\ncolData = data.frame(id = colnames(t(data[1,8:ncol(data)])),\n                     tumor_normal = as.vector(t(data[1,8:ncol(data)])),\n                   row.names=paste0(rep(\"pat\",ncol(assay)),1:ncol(assay)))\nhead(colData)\n```\n\n### Creation of rowData object containing metabolite annotations and ids \n\nFor the rowData object we start off with the annotation already provided by the commercial vendor: \n\n```{r}\nrowData = as.data.frame(data[3:nrow(data),1:7])\ncolnames(rowData) = data[2,1:7]\ncolnames(rowData)[7] = \"HMDB_ID\"\nrownames(rowData) = paste0(rep(\"met\",nrow(assay)),1:nrow(assay))\ncolnames(rowData)\n```\n\n### Annotation using Small Molecular Pathway Database (SMPDB)\n\nAlongside the metabolic measurments, Metabolon &reg; provides metabolite annotation including so called super-pathways and sub-pathways. However, theses annotations might very from vendor to vendor. Hence, the `MetaboDiff` package makes use of the Small Molecular Pathway Database (SMPDB) for metabolite annotation[^3]. `MetaboDiff` supports all common metabolic IDs as input for the annotation (HMDB, KEGG and ChEBI). In the example data, both the KEGG and the HMDB identifier are available. As the databases (HMDB, KEGG or ChEBI) cover unique annotations due to different standards in identifying and reporting metabolites [^4], the function `get_SMPDBanno` queries the database using all three ids (if available) and joins all available information. The current SMPDB build used within `MetaboDiff` is version 2.0 and will be updated as new versions are released. Please refer to the development branch of `MetaboDiff` to work with the latest SMPDB annotation.\n\n```{r}\nrowData = get_SMPDBanno(rowData,\n                        column_kegg_id=6,\n                        column_hmdb_id=7,\n                        column_chebi_id=NA)\n```\n\n## Creation of SummarizedExperiment object and ExperimentList\n\n```{r}\nse = SummarizedExperiment(assays=assay,\n                           rowData=rowData)\nexperiment_list = list(raw=se)\nexperiment_list\n```\n\n## Creation of sampleMap \n\n```{r}\nsampleMap = data.frame(primary=rownames(colData),\n                 colname=colnames(se))\nsampleMap_list = listToMap(list(raw=sampleMap))\n```\n\n## Construction of MultiAssayExperiment\n\n```{r, message=FALSE}\nmet = MultiAssayExperiment(experiments = experiment_list,\n                           colData = colData,\n                           sampleMap = sampleMap_list)\nmet\n```\n\n# Imputation of missing values\n\nIn contrast to microarrays, missing values are common in quantitative metabolomic datasets. \n\nThe function `na_heatmap` visualizes the missing metabolite measurements across the samples. Optionally, a sample label can be displayed (e.g. tumor vs. normal) and the color and name specified.\n\n```{r}\nna_heatmap(met,\n           sample_label=colData(met)$tumor_normal,\n           label_colors=c(\"darkseagreen\",\"dodgerblue\"))\n```\n\nK-nearest neighbour imputation was found ... 40% suggested. Armitage et al., 2015\n\n```{r}\nmet = knn_impute(met,cutoff=0.4)\nmet\n```\n\n# Quality control\n\n```{r}\n#reshape data for ggplot2 using extractor function \nmdata = as.data.frame(longFormat(met[,,1],colDataCols=\"tumor_normal\"))\nmdata$value = log2(mdata$value)\nggplot(mdata, \n       mapping=aes(x=colname,\n                          y=value,\n                          fill=tumor_normal)) + \n    geom_boxplot() + xlab(\"\") +\n    theme(axis.text.x=element_blank()) + ylab(\"log2(raw abundance)\") + scale_fill_manual(values=c(\"darkseagreen\",\"dodgerblue\"))\n```\n\n# Normalization\n\n```{r}\nmet = normalize_met(met)\nmet\n```\n\n```{r,eval=F}\n#reshape data for ggplot2 using extractor function \nmdata = as.data.frame(longFormat(met[,,3],colDataCols=\"tumor_normal\"))\nmdata$value = scale(mdata$value,scale=FALSE)\nggplot(mdata, \n       mapping=aes(x=colname,\n                          y=value,\n                          fill=tumor_normal)) + \n    geom_boxplot() + xlab(\"\") +\n    theme(axis.text.x=element_blank()) + ylab(\"log2(vsn-normalized abundance)\") + scale_fill_manual(values=c(\"darkseagreen\",\"dodgerblue\"))\n```\n\n# Removal of outliers\n\n```{r}\ncol_list = list(grouping=c(\"darkseagreen\",\"dodgerblue\"))\n        names(col_list$grouping)=c(\"N\",\"T\")\n        met_na = is.na(assay(met))*1\n         col_na = apply(met_na,2,sum)/nrow(met_na)\n        colanno = columnAnnotation(df=data.frame(grouping=colData$tumor_normal),\n                                   col=col_list,\n                                   barplot=anno_barplot(col_na[order(col_na)],\n                                                        gp=gpar(fill=\"brown\",\n                                                                col=\"brown\"),\n                                                        axis=TRUE,\n                                                        border=FALSE))\n        \n        \nHeatmap(cor(scale(assays(met)[[\"norm_imputed\"]],scale=FALSE)),\n        show_column_names = FALSE,\n                 show_row_names = FALSE,\n        top_annotation = colanno) \n```\n\nCuttree\n\n```{r}\n\n```\n\n\n# Unsupervised analysis\n\n```{r}\nautoplot(prcomp(t(assays(met)[[\"norm_imputed\"]]),center = TRUE,scale = FALSE),\n         data=as.data.frame(colData(met)),\n         colour=\"tumor_normal\")\n```\n\n\n\n# Comparative analysis\n\n# Variance \n\n```{r}\ndf = data.frame(sd=apply(assays(met)[[3]],1,sd,na.rm=TRUE),\n                smpdb_pathway=rowData(met[[\"norm\"]])$Pathway.Name,\n                super_pathway = rowData(met[[\"norm\"]])$SUPER_PATHWAY)\n```\n\n```{r}\nsd_order=ddply(df,\"super_pathway\",function(df) median(df$sd,na.rm=TRUE))\n\ndf$super_pathway = factor(df$super_pathway,\n                          levels=sd_order$super_pathway[order(sd_order$V1,decreasing=TRUE)])\n\nggplot(df, aes(x=super_pathway,y=sd,fill=super_pathway)) + geom_boxplot() + coord_flip() + guides(fill=FALSE)\n```\n\n```{r}\nsd_order=ddply(df,\"smpdb_pathway\",function(df) median(df$sd,na.rm=TRUE))\n\ndf$smpdb_pathway = factor(df$smpdb_pathway,\n                          levels=sd_order$smpdb_pathway[order(sd_order$V1,decreasing=TRUE)])\n\nggplot(df, aes(x=smpdb_pathway,y=sd,fill=smpdb_pathway)) + geom_boxplot() + coord_flip() + guides(fill=FALSE)\n```\n\n```{r}\nHeatmap(cor(t(assays(met)[[\"norm_imputed\"]])))\n```\n\n\n# Visualization of metabolic networks\n\nTo compare the structure of metabolic networks across tumor entities, network visualizations should ideally be perceptual uniform. However, networks are usually visualized using force-directed layouts (e.g. Fruchterman Reingold[^3]) generating pleasant but hardly interpretable networks earning the nickname ’hairballs’.\n\n## Hive plots\n\nTo address this issue, Kryzwinski et al. have developed an algorithm in which nodes are placed on radially oriented linear axes according to a well-defined coordinate system[^4]. In resemblance to the top of a beehive, the authors termed these visualizations hive plots and show that they can be adjusted to suit the purpose, are easily explained and understood and most importantly can generate useful and quantitatively inter- pretable results.\n\n# Differentially abundant subpathways\n\ngraph clustering - hotnet2 \n\n# Session information\n\n```{r}\nsessionInfo()\n```\n\n# References\n[^1]: Priolo, C., Pyne, S., Rose, J., Regan, E. R., Zadra, G., Photopoulos, C., et al. (2014). AKT1 and MYC Induce Distinctive Metabolic Fingerprints in Human Prostate Cancer. Cancer Research, 74(24), 7198–7204. http://doi.org/10.1158/0008-5472.CAN-14-1490\n\n[^2]: Sig M (2017). MultiAssayExperiment: Software for the integration of multi-omics experiments in Bioconductor. R package version 1.2.1\n\n[^3]: Jewison T, Su Y, Disfany FM, et al. SMPDB 2.0: Big Improvements to the Small Molecule Pathway Database Nucleic Acids Res. 2014 Jan;42(Database issue):D478-84.\n\n[^4]: Thiele, I., Swainston, N., Fleming, R. M. T., Hoppe, A., Sahoo, S., Aurich, M. K., et al. (2013). A community-driven global reconstruction of human metabolism. Nature Biotechnology, 31(5), 419–425. http://doi.org/10.1038/nbt.2488\n\n[^5]: T. M. J. Fruchterman and E. M. Reingold, “Graph drawing by force-directed placement,” Software: Practice and Experience, vol. 21, no. 11, pp. 1129–1164, 1991.\n\n[^6]: M. Krzywinski, I. Birol, S. J. M. Jones, and M. A. Marra, “Hive plots–rational approach to visualizing networks.,” Briefings in Bioinformatics, vol. 13, pp. 627–644, Sept. 2012.\n\n\n",
    "created" : 1498552653941.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3530465170",
    "id" : "B3366B46",
    "lastKnownWriteTime" : 1499864086,
    "last_content_update" : 1499864086723,
    "path" : "~/Documents/PhD/MetaboDiff/vignettes/MetaboDiff_tutorial.Rmd",
    "project_path" : "vignettes/MetaboDiff_tutorial.Rmd",
    "properties" : {
        "last_setup_crc32" : ""
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}